flowchart TD
  A[identify user]
  
  subgraph DevCycle Client SDKs
    direction TB
    B{user validity}
    
    B -->|Not Valid| E[Throw Error]
    
    B -->|Valid| C{User isAnonymous?}
    
    C -->|Yes| C1{Anon user id in cache?}
    C1 -->|No| C2[Generate new anon user id]
    C1 -->|Yes| C3[Read anon user id from cache]
    C2 --> WCIR((Wait for client initialization))
    C3 --> WCIR
    
    C -->|No| WCIR
    WCIR -->|Failed| NE[Notify user of error]
    WCIR -->|Succeeded| PC{Previous identify call in progress?}
    
    PC -->|Yes| AQ[Add identity call to queue]
    AQ --> WPIC[Wait for previous identity call to complete]
    WPIC --> TLUEDB[Take latest user in queue]
    
    PC -->|No| TLUEDB
    
    TLUEDB --> FCR{API Fetch Config}
    FCR -->|Unsuccessful| NUOEICQ[Notify user of error]
    FCR -->|Successful| WSUC[Write saved user cache]
    
    WSUC --> FEUOU[Flush events using old user]
    FEUOU --> CDVC[Call DVCVariable callbacks of changed variables]
    CDVC --> EFV[Emit events of features and variables that have changed]
    EFV --> RULFICQ[Return user call for the latest identity call in queue]
    RULFICQ --> UDUP[Update DVClient user property]
    UDUP --> EDU{edgeDB update?}
    
    EDU -->|Yes| ASUD[API Store User Data]
    EDU -->|No| END[End]
    
    ASUD --> END
  end
  
  A --> B
  
  %% Style: emit event nodes
  classDef emitEvent fill:#fff3bf,stroke:#333,color:#000;
  class EFV emitEvent;
  
  %% Style: error nodes
  classDef errorNode fill:#ffcccc,stroke:#333,color:#000;
  class E,NE,NUOEICQ errorNode;
  
  %% Style: API call nodes
  classDef apiCall fill:#e1f5fe,stroke:#0277bd,color:#000;
  class FCR,ASUD apiCall;
  
  %% Style: terminal nodes
  classDef terminal fill:#f3e5f5,stroke:#7b1fa2,color:#000;
  class END terminal;