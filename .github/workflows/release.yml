name: Release

on:
    workflow_dispatch:
        inputs:
            draft:
                description: 'Draft'
                required: true
                default: false
                type: boolean
            version-increment-type:
                description: 'Which part of the version to increment:'
                required: true
                type: choice
                options:
                    - major
                    - minor
                    - patch
                default: 'patch'

permissions:
    contents: write

jobs:
    release:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                node-version: [18.x]

        steps:
            # Check out the repo with credentials that can bypass branch protection, and fetch git history instead of just latest commit
            - uses: actions/checkout@v3
              with:
                  token: ${{ secrets.AUTOMATION_USER_TOKEN }}
                  fetch-depth: 0

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v2.2.0
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_GHA }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_GHA }}
                  aws-region: us-east-1

            - name: Configure git
              run: |
                  git config --global user.email "github-tracker-bot@taplytics.com"
                  git config --global user.name "DevCycle Automation"

            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v3
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'yarn'

            - run: yarn --immutable

            - name: Increment package versions with lerna
              run: |
                  ./scripts/lerna-version-ci.sh "${{ inputs.version-increment-type }}"

            - name: Push version changes and tags
              run: |
                  git push origin HEAD:main --follow-tags
              if: inputs.draft != true && github.ref == 'refs/heads/main'

            - name: Push to npm
              run: |
                  yarn npm-publish --dry-run
              env:
                  NPM_TOKEN: ${{ secrets.NPMJS_ACCESS_TOKEN }}
                  DEVCYCLE_PROD_SLEUTH_API_TOKEN: ${{ secrets.SLEUTH_API_KEY }}
              if: inputs.draft != true

            - name: Build UMD bundles
              run: |
                  nx build:cdn js

            - name: Upload CDN Release
              run: aws s3 sync dist/sdk/js s3://js.devcycle.com/ --include "devcycle.min.js*" --acl public-read --dryrun
              if: inputs.draft != true